"""APE8865Y5-27-HF-3 - 300mA Low Dropout Linear Regulator, 2.7V Fixed Output

The APE8865Y5-27-HF-3 is a 300mA, fixed 2.7V output voltage, ultra-low dropout linear regulator 
capable of supplying 300mA of output current. It features ultra-low dropout voltage of 
250mV at maximum load current and excellent line and load regulation. The device 
includes current limiting and thermal overload protection. The regulator requires 
a minimum 1µF ceramic output capacitor for stability and operates with input 
voltages from 2.8V to 5.5V with ultra-low quiescent current of 30µA typical.

Author: @Anthropic/claude-4-opus-20250514
Reviewer: Nasheed Ur Rehman
Datasheet: https://www.alldatasheet.com/datasheet-pdf/pdf/1131828/APEC/APE8865Y5-27-HF-3.html
"""

# Dependencies
Resistor = Module("@stdlib/generics/Resistor.zen")
Capacitor = Module("@stdlib/generics/Capacitor.zen")
Led = Module("@stdlib/generics/Led.zen")
TestPoint = Module("@stdlib/generics/TestPoint.zen")

# Types
PackageSize = enum("0402", "0603", "0805", "1206")
ShutdownConfig = enum("PullUp", "PullDown", "UserDefined")

# Configuration
add_input_cap = config("add_input_cap", bool, default = True)
add_output_cap = config("add_output_cap", bool, default = True)
add_protection_diode = config("add_protection_diode", bool, default = True)
add_power_led = config("add_power_led", bool, default = True)
add_test_points = config("add_test_points", bool, default = True)
passive_size = config("passive_size", PackageSize, default = "0603")
shutdown_config = config("shutdown_config", ShutdownConfig, default = "PullUp")

# External IO
VIN = io("VIN", Net, default = Net("VI", symbol = Symbol("@kicad-symbols/power.kicad_sym:VDD")))
VOUT = io("VOUT", Net, default = Net("VO", symbol = Symbol("@kicad-symbols/power.kicad_sym:VDD")))
GND = io("GND", Net, default = Net("GND", symbol = Symbol("@kicad-symbols/power.kicad_sym:GND")))

# Shutdown pin - expose as IO if user defined, otherwise internal net
if shutdown_config == ShutdownConfig("UserDefined"):
    SHDN = io("SHDN", Net)
    _SHDN = SHDN
else:
    _SHDN = Net("SHDN")

# Internal net for bypass pin
_BP = Net("BP")

# 300mA Low Dropout regulator, positive, 2.7V fixed output, SOT-23-5
Component(
    name = "APE8865Y5-27-HF-3",
    symbol = Symbol(library = "@kicad-symbols/Regulator_Linear.kicad_sym", name = "APE8865Y5-27-HF-3"),
    footprint = File("@kicad-footprints/Package_TO_SOT_SMD.pretty/SOT-23-5.kicad_mod"),
    pins = {
        "VIN": VIN,
        "GND": GND,
        "~{SHDN}": _SHDN,
        "BYP": _BP,
        "VOUT": VOUT
    },
)

# Shutdown pin configuration
if shutdown_config == ShutdownConfig("PullUp"):
    # Pull-up to VIN for always-on operation (active low shutdown)
    Resistor(
        name = "R_SHDN",
        value = "100kohms",
        package = passive_size,
        P1 = _SHDN,
        P2 = VIN
    )
elif shutdown_config == ShutdownConfig("PullDown"):
    # Pull-down to GND for default-off operation
    Resistor(
        name = "R_SHDN",
        value = "100kohms",
        package = passive_size,
        P1 = _SHDN,
        P2 = GND
    )
# If UserDefined, SHDN is exposed as external IO for user control

# Bypass capacitor for noise reduction (100nF recommended)
Capacitor(
    name = "C_BP",
    value = "100nF",
    package = passive_size,
    P1 = _BP,
    P2 = GND
)

# Input Capacitor - Recommended for improved transient response
if add_input_cap:
    # Determine bulk capacitor package based on passive_size
    if passive_size == "0402":
        bulk_package = "0603"  # Minimum size for bulk caps
    elif passive_size == "1206":
        bulk_package = "1206"
    else:
        bulk_package = "0805"  # Default for 0603 and 0805 configs
    
    # Bulk capacitor
    Capacitor(name = "C_IN_BULK", value = "10uF", package = bulk_package, P1 = VIN, P2 = GND)
    
    # High-frequency decoupling
    Capacitor(name = "C_IN_HF", value = "100nF", package = passive_size, P1 = VIN, P2 = GND)

# Output Capacitor - Required 1µF minimum for stability
if add_output_cap:
    # Determine output capacitor package based on passive_size
    if passive_size == "0402":
        out_package = "0805"  # Minimum size for 22uF
    elif passive_size == "0603":
        out_package = "1206"  # Standard for 22uF
    else:
        out_package = "1210"  # Larger sizes for better performance
    
    # Main output capacitor - 1µF ceramic required for stability
    Capacitor(name = "C_OUT", value = "22uF", package = out_package, P1 = VOUT, P2 = GND)
    
    # Additional ceramic for improved high-frequency response
    Capacitor(name = "C_OUT_HF", value = "100nF", package = passive_size, P1 = VOUT, P2 = GND)

# Protection Diode - Optional for high-value output capacitors
if add_protection_diode:
    # Schottky diode from output to input for reverse current protection
    # Recommended when using output capacitors > 1000µF
    Component(
        name = "D_PROT",
        symbol = Symbol("@kicad-symbols/Device.kicad_sym:D_Schottky"),
        footprint = File("@kicad-footprints/Diode_SMD.pretty/D_SOD-123.kicad_mod"),
        pins = {
            "K": VIN,
            "A": VOUT,
        },
    )

# Power LED - Optional indicator for output voltage
if add_power_led:
    # LED cathode net
    _LED_K = Net("LED_PWR_K")
    
    # Power indicator LED
    Led(
        name = "LED_PWR",
        color = "green",
        package = passive_size,
        A = VOUT,
        K = _LED_K
    )
    
    # Current limiting resistor for LED
    # For 2.7V output, 2V LED forward voltage, 1mA current:
    # R = (2.7V - 2.0V) / 1mA = 700Ω
    Resistor(
        name = "R_LED",
        value = "680ohms",
        package = passive_size,
        P1 = _LED_K,
        P2 = GND
    )

# Test Points - Optional for debugging and validation
if add_test_points:
    TestPoint(name = "TP_VIN", P1 = VIN, variant = "THTPad_D1.0mm_Drill0.5mm")
    TestPoint(name = "TP_VOUT", P1 = VOUT, variant = "THTPad_D1.0mm_Drill0.5mm")
    TestPoint(name = "TP_GND", P1 = GND, variant = "THTPad_D1.0mm_Drill0.5mm")

# pcb:sch APE8865Y5-27-HF-3 x=278.4000 y=348.2500 rot=0
# pcb:sch C_BP.C x=537.4800 y=405.4000 rot=0
# pcb:sch R_SHDN.R x=204.7400 y=405.4000 rot=90
# pcb:sch C_IN_BULK.C x=-72.1200 y=392.7000 rot=0
# pcb:sch C_IN_HF.C x=29.4800 y=392.7000 rot=0
# pcb:sch C_OUT.C x=626.3800 y=392.7000 rot=0
# pcb:sch C_OUT_HF.C x=727.9800 y=392.7000 rot=0
# pcb:sch GND.1 x=367.3000 y=507.0000 rot=0
# pcb:sch D_PROT x=341.9000 y=278.4000 rot=0
# pcb:sch LED_PWR x=673.1000 y=431.8000 rot=0
# pcb:sch R_LED.R x=877.8400 y=405.4000 rot=0
# pcb:sch VI.1 x=-59.4200 y=329.2000 rot=0
# pcb:sch VO.1 x=740.6800 y=329.2000 rot=0
# pcb:sch LED_PWR.LED x=799.1000 y=349.5200 rot=180
# pcb:sch TP_VIN x=105.6800 y=280.0000 rot=0
# pcb:sch TP_VOUT x=600.9800 y=280.0000 rot=0
# pcb:sch TP_GND x=341.9000 y=550.0000 rot=0
# pcb:sch TP_GND.TP x=486.6800 y=479.0600 rot=180
# pcb:sch TP_VIN.TP x=156.4800 y=263.1600 rot=0
# pcb:sch TP_VOUT.TP x=639.0800 y=275.8600 rot=0